<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Decreto 67 - Sistema Integral</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Animaciones */
        @media screen {
            .fade-in { animation: fadeIn 0.3s ease-in-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            
            .fade-out-row { 
                transition: all 0.5s ease;
                opacity: 0; 
                transform: translateX(50px); 
                background-color: #fee2e2 !important; 
            }
        }

        /* TIPOGRAFÍA GLOBAL */
        body, input, textarea, select, button, div {
            font-family: Arial, Helvetica, sans-serif !important;
        }

        /* Estilos de Formulario Genéricos */
        input.editable, textarea.editable, select.editable, div.editable-div {
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            transition: border-color 0.2s, background-color 0.2s;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        input.editable:focus, textarea.editable:focus, select.editable:focus, div.editable-div:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Auto-expansión en pantalla */
        .auto-grow {
            min-height: 60px;
            overflow-y: hidden; 
            resize: none; 
            display: block;
        }

        /* CLASE PARA IMPRESIÓN (Texto expandido) */
        .print-text-block {
            display: none; /* Oculto en pantalla */
            white-space: pre-wrap; /* Mantiene párrafos */
            text-align: justify;
            width: 100%;
            font-size: 10pt; /* Tamaño óptimo para impresión */
            line-height: 1.4;
            color: #000;
        }
        
        /* Inputs transparentes */
        input.transparent-input {
            background: transparent;
            border: 1px dashed transparent;
            width: auto;
            min-width: 50px;
            text-align: center;
        }
        input.transparent-input:hover { border-color: #cbd5e1; }
        input.transparent-input:focus { border-color: #3b82f6; background: white; }

        /* Botones sugerencias */
        .suggestion-btn { text-align: left; transition: all 0.2s; }
        .suggestion-btn:hover { transform: translateX(2px); background-color: #eff6ff; }

        /* Logo Placeholder */
        .logo-placeholder {
            border: 2px dashed #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logo-placeholder:hover { border-color: #60a5fa; background-color: rgba(255,255,255,0.1); }

        /* Modal Overlay */
        #delete-modal {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* --- REGLAS DE IMPRESIÓN --- */
        @media print {
            .no-print, header, nav, #action-buttons, .suggestion-btn-container, .logo-upload-hint, .template-buttons, #delete-modal { 
                display: none !important; 
            }

            /* Ocultar inputs/textareas de edición y mostrar bloques de texto */
            textarea.editable { display: none !important; }
            .print-text-block { display: block !important; border: none !important; padding: 0 !important; margin-top: 5px; }
            
            /* Ajustes para inputs de una línea (Nombre, RUT, etc) */
            input.editable {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                font-weight: bold;
            }

            body { 
                background-color: white; 
                color: black; 
                font-size: 11pt !important;
                line-height: 1.3;
            }
            .container { 
                max-width: 100% !important; 
                padding: 0 !important; 
                margin: 0 !important;
                width: 100% !important;
            }

            /* Control de Vistas */
            body.printing-repitencia #view-ficha,
            body.printing-repitencia #view-analisis,
            body.printing-repitencia #view-decision,
            body.printing-repitencia #print-header-general { display: block !important; }
            body.printing-repitencia #view-tutoria, 
            body.printing-repitencia #view-historial { display: none !important; }

            body.printing-tutoria #view-tutoria { display: block !important; margin-top: 0 !important; }
            body.printing-tutoria #view-ficha,
            body.printing-tutoria #view-analisis,
            body.printing-tutoria #view-decision,
            body.printing-tutoria #print-header-general,
            body.printing-tutoria #view-historial { display: none !important; }

            .view-section { margin-bottom: 15px; display: block; width: 100%; break-inside: auto; }
            
            .avoid-break {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .print-spacer {
                margin-bottom: 0.5cm !important;
            }
            
            @page { margin: 1.5cm; size: letter; }
            
            .print-header-flex {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                gap: 15px;
                margin-bottom: 1rem;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            .print-logo { width: 90px; height: 90px; object-fit: contain; }
            
            /* Limpieza visual */
            .bg-white, .rounded-lg, .shadow-sm, .border {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
            }
            .bg-slate-50, .bg-blue-50, .bg-red-50, .bg-green-50, .bg-purple-50, .bg-yellow-50 {
                background-color: transparent !important; /* Quita fondos de color al imprimir */
            }
            
            .border-b { border-bottom: 1px solid #ccc !important; margin-bottom: 5px !important; }
            .border-l-4 { border-left: 3px solid #000 !important; padding-left: 10px !important; margin-left: 0 !important; }
            
            .editable-title {
                font-size: 16pt !important;
                line-height: 1.2 !important;
                text-transform: uppercase;
                font-weight: bold;
                text-align: center;
            }

            .vertical-grades-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
            .vertical-grades-table th, .vertical-grades-table td { border: 1px solid #000; padding: 4px 8px; text-align: center; font-size: 11pt; }
            .vertical-grades-table th { background-color: #f0f0f0 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            
            .auto-calculated { background-color: transparent !important; color: black !important; }
        }

        @media screen {
            .view-section.hidden-tab { display: none; }
            #print-header-general { display: block; margin-bottom: 20px; }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 min-h-screen pb-12">

    <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 animate-bounce-in">
            <div class="text-center mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Confirmar Eliminación</h3>
                <p class="text-sm text-gray-500 mt-2">
                    Está a punto de eliminar el expediente del estudiante: <br>
                    <span id="delete-modal-student" class="font-bold text-gray-800"></span>
                </p>
                <div class="bg-blue-50 border border-blue-100 rounded p-2 mt-3 text-xs text-blue-800 text-left">
                    <i class="fa-solid fa-info-circle"></i> <strong>Nota:</strong> Esta acción eliminará tanto el <u>Informe de Repitencia</u> como el <u>Informe de Tutoría</u> asociado.
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Responsable:</label>
                <input type="text" id="delete-responsable-name" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-red-500 focus:border-red-500" placeholder="Escriba su nombre para confirmar">
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="window.closeDeleteModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium">Cancelar</button>
                <button onclick="window.confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium shadow-md">Eliminar Informe</button>
            </div>
        </div>
    </div>

    <input type="file" id="logo-uploader" accept="image/*" class="hidden" onchange="window.loadLogo(event)">

    <header class="bg-blue-900 text-white shadow-lg no-print">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="relative group cursor-pointer" onclick="document.getElementById('logo-uploader').click()">
                    <div id="screen-logo-container" class="w-16 h-16 bg-blue-800 rounded-lg logo-placeholder flex flex-col items-center justify-center text-blue-300 overflow-hidden">
                        <i class="fa-solid fa-image text-xl mb-1"></i>
                        <span class="text-[8px] text-center px-1">Subir Logo</span>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight">GESTOR DECRETO 67</h1>
                    <p class="text-blue-200 text-xs">Evaluación y Promoción Escolar</p>
                    <p class="text-green-300 text-[10px] mt-0.5 font-medium flex items-center gap-1">
                        <i class="fa-solid fa-link"></i> Conectado
                    </p>
                    <p class="text-blue-300 text-[10px] mt-0.5 italic opacity-80">desarrollado por ProfeAle</p>
                </div>
            </div>
            <div class="text-right hidden md:block">
                <p class="font-medium text-sm header-student-name">Estudiante</p>
                <p class="text-blue-300 text-xs header-student-run">RUT</p>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-10 no-print shadow-sm">
        <div class="container mx-auto px-6 overflow-x-auto">
            <div class="flex space-x-6" id="nav-tabs">
                <button onclick="window.switchTab('ficha')" id="tab-ficha" class="flex items-center gap-2 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-user-pen"></i> 1. Ficha
                </button>
                <button onclick="window.switchTab('analisis')" id="tab-analisis" class="flex items-center gap-2 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-chart-line"></i> 2. Análisis
                </button>
                <button onclick="window.switchTab('decision')" id="tab-decision" class="flex items-center gap-2 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-file-signature"></i> 3. Resolución
                </button>
                <button onclick="window.switchTab('tutoria')" id="tab-tutoria" class="flex items-center gap-2 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-chalkboard-user"></i> 4. Anexo Tutoría
                </button>
                <button onclick="window.switchTab('historial')" id="tab-historial" class="flex items-center gap-2 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-colors whitespace-nowrap ml-auto bg-slate-50 px-4 rounded-t-lg">
                    <i class="fa-solid fa-chart-pie"></i> 5. Gestión e Historial
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 md:px-6 py-8 max-w-5xl">
        
        <div id="print-header-general" class="hidden-tab-tutoria hidden-tab-historial">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6 print:mb-2">
                <div class="print-header-flex flex flex-col md:flex-row items-center justify-between gap-4 border-b-2 border-slate-800 pb-4">
                    <div class="w-24 h-24 flex-shrink-0 flex items-center justify-center">
                        <img id="print-logo-repitencia" src="" class="print-logo w-full h-full object-contain hidden" alt="Logo">
                        <div id="placeholder-logo-rep" class="text-xs text-slate-400 text-center border-2 border-dashed border-slate-200 p-2 rounded no-print cursor-pointer" onclick="document.getElementById('logo-uploader').click()">
                            (Clic Logo)
                        </div>
                    </div>
                    
                    <div class="text-center flex-1 w-full">
                        <div contenteditable="true" 
                             class="editable-title text-2xl font-bold text-slate-900 text-center w-full uppercase outline-none focus:bg-blue-50 rounded p-1"
                             oninput="window.updateData('reportInfo.title', this.innerText)">INFORME DE REPITENCIA ESCOLAR</div>
                        <p class="text-sm text-slate-500 mt-1">Según Decreto de Evaluación y Promoción Nº 67/2018</p>
                    </div>

                    <div class="text-right text-sm min-w-[150px]">
                        <div class="flex items-center justify-end gap-2 mb-1">
                            <span class="font-bold text-slate-700">Nº Folio:</span>
                            <input type="text" id="report-number-input" class="font-bold text-red-600 text-right transparent-input w-24" 
                                   value="---" readonly placeholder="Auto">
                        </div>
                        <div class="flex items-center justify-end gap-2">
                            <span class="font-bold text-slate-700">Fecha:</span>
                            <input type="date" class="text-slate-900 text-right transparent-input w-32" 
                                   value="2025-12-05"
                                   oninput="window.updateData('reportInfo.date', this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ficha" class="view-section"></div>
        <div id="view-analisis" class="view-section hidden-tab mt-6"></div>
        <div id="view-decision" class="view-section hidden-tab mt-6"></div>
        <div id="view-tutoria" class="view-section hidden-tab mt-6"></div>
        
        <div id="view-historial" class="view-section hidden-tab mt-6 no-print">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-4 rounded-lg shadow border border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase">Total Informes</p>
                    <p class="text-3xl font-bold text-blue-600" id="stat-total">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase">Situación: Repitencia</p>
                    <p class="text-3xl font-bold text-red-600" id="stat-repitencia">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase">Promedio General Notas</p>
                    <p class="text-3xl font-bold text-slate-800" id="stat-promedio">0.0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow border border-slate-200 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-folder-open"></i> Registros
                    </h2>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <div class="relative w-full md:w-64">
                            <input type="text" id="search-input" placeholder="Buscar por nombre o RUT..." 
                                   class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded text-sm focus:border-blue-500 focus:outline-none"
                                   onkeyup="window.filterHistory()">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                        </div>
                        <button onclick="window.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded flex items-center gap-2 transition-colors">
                            <i class="fa-solid fa-file-excel"></i> Exportar
                        </button>
                        <button onclick="window.loadHistoryFromDB()" class="text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-2 rounded text-sm transition-colors">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                            <tr>
                                <th class="px-4 py-3">Folio</th>
                                <th class="px-4 py-3">Fecha</th>
                                <th class="px-4 py-3">Estudiante</th>
                                <th class="px-4 py-3">RUT</th>
                                <th class="px-4 py-3 text-center">Nota</th>
                                <th class="px-4 py-3">Decisión</th>
                                <th class="px-4 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historial-list-body">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="action-buttons" class="flex justify-end gap-4 mt-8 no-print pb-12 flex-wrap">
            <button onclick="window.saveData()" class="flex items-center gap-2 px-4 py-2 border border-green-600 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 font-medium transition-colors">
                <i class="fa-solid fa-cloud-arrow-up"></i> Guardar y Generar Folio
            </button>
            <button onclick="window.printRepitencia()" class="flex items-center gap-2 px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-bold shadow-md transition-colors">
                <i class="fa-solid fa-file-pdf"></i> Imprimir Repitencia
            </button>
            <button onclick="window.printTutoria()" class="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors">
                <i class="fa-solid fa-file-contract"></i> Imprimir Tutoría
            </button>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, addDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAisxzJVm2OzjYEXSi4Q7HxZEUG_aarQwo",
            authDomain: "notas-liceo-agricola-sscc.firebaseapp.com",
            databaseURL: "https://notas-liceo-agricola-sscc-default-rtdb.firebaseio.com",
            projectId: "notas-liceo-agricola-sscc",
            storageBucket: "notas-liceo-agricola-sscc.firebasestorage.app",
            messagingSenderId: "434804825732",
            appId: "1:434804825732:web:8c9035fa88be54cd6facd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; window.loadHistoryFromDB(); } 
            else { signInAnonymously(auth).catch(e => console.error("Auth:", e)); }
        });

        // --- FUNCIÓN MEJORADA: AJUSTE AUTOMÁTICO DE ALTURA ---
        window.autoResize = function(el) {
            if (!el) return;
            el.style.height = 'auto'; // Resetea para medir
            el.style.height = (el.scrollHeight + 2) + 'px'; 
        };

        // --- NUEVA FUNCIÓN: Sincronizar input con div de impresión (DUAL SYSTEM) ---
        window.syncPrintText = function(textarea, path) {
            window.autoResize(textarea);
            window.updateData(path, textarea.value);
            // Buscar el div hermano para impresión y actualizarlo
            const printDiv = textarea.nextElementSibling;
            if (printDiv && printDiv.classList.contains('print-text-block')) {
                printDiv.textContent = textarea.value;
            }
        };

        // --- CREAR BLOQUE EDITABLE (REUTILIZABLE PARA AMBOS INFORMES) ---
        window.createEditableBlock = function(label, value, path, heightClass = "h-24", extraClass = "") {
            const header = label ? `<h4 class="font-bold text-xs uppercase text-slate-700 mb-1 bg-slate-50 p-1 inline-block rounded border border-slate-200">${label}</h4>` : '';
            return `
            <div class="avoid-break mb-4 ${extraClass}">
                ${header}
                <textarea 
                    class="editable w-full text-justify text-sm auto-grow transition-all duration-200 ease-in-out ${heightClass}" 
                    oninput="window.syncPrintText(this, '${path}')"
                >${value || ''}</textarea>
                <div class="print-text-block text-sm text-justify">${value || ''}</div>
            </div>`;
        };

        // --- Estado ---
        let data = {
            reportInfo: {
                title: "INFORME DE REPITENCIA ESCOLAR",
                number: "", 
                date: new Date().toISOString().split('T')[0] 
            },
            student: {
                name: "", run: "", dob: "", course: "", guardian: "", tutor: "", tutorSubject: "", interviews: ""
            },
            academic: {
                sem1Avg: 0, sem2Avg: 0, finalAvg: 0, courseAvg: 0, failedSubjectsText: ""
            },
            decree67Analysis: {
                progress: "", gap: "", socioemotional: "", additionalEvidence: ""
            },
            decision: {
                status: "Repitencia", justification: ""
            },
            plan2025: {
                schoolCommitments: "", familyCommitments: ""
            },
            tutoria: {
                reportNumber: "", tutor1: "", tutor2: "", reportDate: new Date().toISOString().split('T')[0],
                showSem1: false, showSem2: true,
                sem1: { startMonth: "Marzo", endMonth: "Junio", situation: "", agreements: "", commitments: "", observations: "" },
                sem2: { startMonth: "Julio", endMonth: "Diciembre", situation: "", agreements: "", commitments: "", observations: "" }
            },
            logoUrl: null
        };

        const criteriaOptions = {
            progress: ["Aunque hubo mejora en el segundo semestre, el avance no fue suficiente...", "El estudiante muestra un estancamiento...", "Se observa una mejora sostenida, pero el déficit inicial...", "Rendimiento fluctuante..."],
            gap: ["La brecha con el curso es significativa...", "Existe una brecha académica leve...", "El estudiante se encuentra muy por debajo del promedio...", "Falta de autonomía en el trabajo escolar..."],
            socioemotional: ["Se observan problemas de autoestima académica...", "Situación familiar compleja...", "Manifiesta baja tolerancia a la frustración...", "Se requiere fortalecer el vínculo..."]
        };

        let cachedHistory = [];

        window.updateData = function(path, value) {
            const keys = path.split('.'); let obj = data;
            for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
            obj[keys[keys.length - 1]] = value;

            if(path === 'student.name') updateUI('name', value);
            if(path === 'student.run') updateUI('run', value);
            if(path === 'student.course') updateUI('course', value);
            if(path === 'reportInfo.number') {
                const el = document.getElementById('report-number-input'); if(el) el.value = value;
            }
            if(path.includes('academic')) {
                if(path === 'academic.sem1Avg' || path === 'academic.sem2Avg') {
                    const s1 = parseFloat(data.academic.sem1Avg) || 0;
                    const s2 = parseFloat(data.academic.sem2Avg) || 0;
                    if(s1 > 0 && s2 > 0) {
                        data.academic.finalAvg = ((s1 + s2) / 2).toFixed(1);
                        const finalInput = document.getElementById('input-final-avg'); if(finalInput) finalInput.value = data.academic.finalAvg;
                    }
                }
                if(document.getElementById('chart-container')) renderChartBars();
            }
            if(path.includes('tutoria.showSem')) renderTutoria();
        };

        function updateUI(type, value) {
            if(type === 'name') {
                document.querySelectorAll('.header-student-name').forEach(el => el.textContent = value || "Estudiante");
                const input = document.getElementById('input-tut-name'); if(input && input !== document.activeElement) input.value = value;
            }
            if(type === 'run') {
                document.querySelectorAll('.header-student-run').forEach(el => el.textContent = value || "RUT");
                const input = document.getElementById('input-tut-run'); if(input && input !== document.activeElement) input.value = value;
            }
            if(type === 'course') {
                const input = document.getElementById('input-tut-course'); if(input && input !== document.activeElement) input.value = value;
            }
        }

        window.fillTutoriaTemplate = function(type) {
             if(type === 'success') {
                window.updateData('tutoria.sem2.situation', 'El estudiante ha demostrado un avance significativo, superando las dificultades detectadas en el diagnóstico inicial. Ha mejorado su asistencia y participación en clases.');
                window.updateData('tutoria.sem2.agreements', 'Se acuerda mantener el monitoreo periódico pero se da por finalizado el plan de intervención intensiva debido a los buenos resultados.');
                window.updateData('tutoria.sem2.commitments', 'Mantener la constancia en el estudio y la asistencia regular.');
                window.updateData('tutoria.sem2.observations', 'Estudiante PROMOVIDO con sus dificultades superadas. Se felicita a la familia por el apoyo brindado.');
            } else if (type === 'process') {
                window.updateData('tutoria.sem2.situation', 'El estudiante presenta avances parciales. Si bien ha mejorado en algunos indicadores, aún requiere apoyo para consolidar aprendizajes basales.');
                window.updateData('tutoria.sem2.agreements', 'Se mantendrá la tutoría para el próximo año escolar, con énfasis en las asignaturas críticas.');
                window.updateData('tutoria.sem2.commitments', 'Reforzar rutinas de estudio en el hogar y asegurar asistencia a reforzamientos.');
                window.updateData('tutoria.sem2.observations', 'Se sugiere evaluación diferenciada para el inicio del próximo periodo.');
            } else if (type === 'fail') {
                window.updateData('tutoria.sem2.situation', 'El estudiante mantiene un rendimiento descendido y asistencia irregular, no logrando los objetivos mínimos del nivel.');
                window.updateData('tutoria.sem2.agreements', 'Se informa la situación de repitencia y se reestructurará el plan de apoyo para el próximo año.');
                window.updateData('tutoria.sem2.commitments', 'La familia se compromete a garantizar la asistencia y supervisión académica.');
                window.updateData('tutoria.sem2.observations', 'Situación académica crítica que deriva en repitencia escolar según Decreto 67.');
            }
            renderTutoria(); 
            alert("Textos de plantilla cargados en la sección de Tutoría.");
        };

        function generateNextFolio(existingDocs) {
            const year = new Date().getFullYear();
            let maxSeq = 0;
            existingDocs.forEach(doc => {
                const numStr = doc.reportInfo?.number || "";
                const match = numStr.match(/^(\d+)-(\d{4})$/);
                if (match && match[2] == year) {
                    const seq = parseInt(match[1], 10);
                    if (seq > maxSeq) maxSeq = seq;
                }
            });
            return `${String(maxSeq + 1).padStart(3, '0')}-${year}`;
        }

        window.saveData = async function() {
            if (!currentUser) return alert("Conectando... espere un momento.");
            try {
                if (!data.reportInfo.number || data.reportInfo.number === "---" || data.reportInfo.number === "") {
                    const q = collection(db, 'artifacts', 'liceo-agricola', 'public', 'data', 'informes');
                    const snapshot = await getDocs(q);
                    let existingDocs = [];
                    snapshot.forEach(d => existingDocs.push(d.data()));
                    data.reportInfo.number = generateNextFolio(existingDocs);
                    window.updateData('reportInfo.number', data.reportInfo.number);
                }
                const cleanRut = data.student.run ? data.student.run.replace(/[^0-9kK]/g, '') : "sin_rut";
                const docId = data.id || `${cleanRut}_${Date.now()}`; 
                data.id = docId;
                await setDoc(doc(db, 'artifacts', 'liceo-agricola', 'public', 'data', 'informes', docId), {
                    ...data,
                    lastEditedBy: currentUser.uid,
                    savedAt: new Date().toISOString()
                });
                alert(`Informe guardado con Folio N°: ${data.reportInfo.number}`);
                window.loadHistoryFromDB();
            } catch (e) {
                console.error(e);
                alert('Error al guardar: ' + e.message);
            }
        };

        window.loadHistoryFromDB = async function() {
            const tbody = document.getElementById('historial-list-body');
            try {
                const q = collection(db, 'artifacts', 'liceo-agricola', 'public', 'data', 'informes');
                const snapshot = await getDocs(q);
                let docs = [];
                snapshot.forEach(doc => docs.push({ ...doc.data(), id: doc.id })); 
                docs.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
                cachedHistory = docs;
                calculateStats(docs); 
                window.filterHistory(); 
            } catch (e) {
                console.error(e);
                if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 py-4">Error al cargar historial.</td></tr>`;
            }
        };

        function calculateStats(docs) {
            const totalEl = document.getElementById('stat-total');
            const repitenciaEl = document.getElementById('stat-repitencia');
            const promedioEl = document.getElementById('stat-promedio');
            if (!totalEl) return;
            totalEl.textContent = docs.length;
            repitenciaEl.textContent = docs.filter(d => d.decision?.status === 'Repitencia').length;
            const validGrades = docs.map(d => parseFloat(d.academic?.finalAvg)).filter(n => !isNaN(n) && n > 0);
            promedioEl.textContent = validGrades.length ? (validGrades.reduce((a, b) => a + b, 0) / validGrades.length).toFixed(1) : "0.0";
        }

        window.filterHistory = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = cachedHistory.filter(doc => {
                const name = (doc.student?.name || "").toLowerCase();
                const run = (doc.student?.run || "").toLowerCase();
                return name.includes(searchTerm) || run.includes(searchTerm);
            });
            renderHistoryTable(filtered);
        };

        window.exportToExcel = function() {
            if (!cachedHistory.length) return alert("No hay datos para exportar.");
            let csvContent = "data:text/csv;charset=utf-8,Folio,Fecha,Nombre Estudiante,RUT,Curso,Promedio Final,Decision,Causa\n"; 
            cachedHistory.forEach(doc => {
                const row = [doc.reportInfo?.number, new Date(doc.savedAt).toLocaleDateString(), `"${doc.student?.name}"`, doc.student?.run, doc.student?.course, doc.academic?.finalAvg, doc.decision?.status, `"${(doc.decision?.justification || "").replace(/\n/g, ' ')}"`].join(",");
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `reporte_decreto67_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.deleteReport = async function(docId, folio, studentName) {
            const responsibleName = prompt(`ADVERTENCIA: Está a punto de eliminar el expediente de ${studentName}.\n\nPara confirmar, escriba SU NOMBRE:`);
            if (!responsibleName || responsibleName.trim().length < 3) return alert("Cancelado.");
            try {
                await addDoc(collection(db, 'artifacts', 'liceo-agricola', 'public', 'data', 'logs_eliminacion'), { deletedFolio: folio, deletedStudent: studentName, deletedBy: responsibleName, deletedAt: new Date().toISOString() });
                await deleteDoc(doc(db, 'artifacts', 'liceo-agricola', 'public', 'data', 'informes', docId));
                window.loadHistoryFromDB();
            } catch (e) { alert("Error al eliminar."); }
        };

        function renderHistoryTable(docs) {
            const tbody = document.getElementById('historial-list-body');
            if(!tbody) return;
            if (docs.length === 0) return tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">No se encontraron resultados.</td></tr>';
            tbody.innerHTML = docs.map(doc => `
                <tr id="row-${doc.id}" class="bg-white border-b hover:bg-slate-50 transition-colors">
                    <td class="px-4 py-3 font-bold text-slate-700">${doc.reportInfo?.number || "S/N"}</td>
                    <td class="px-4 py-3 text-slate-500 text-xs">${new Date(doc.savedAt).toLocaleDateString()}</td>
                    <td class="px-4 py-3 font-medium text-slate-900">${doc.student?.name || 'Sin Nombre'}</td>
                    <td class="px-4 py-3 text-slate-500">${doc.student?.run || '-'}</td>
                    <td class="px-4 py-3 text-center font-bold ${parseFloat(doc.academic?.finalAvg)<4?'text-red-600':'text-slate-700'}">${doc.academic?.finalAvg || '-'}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${doc.decision?.status === 'Repitencia' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${doc.decision?.status || 'Pendiente'}</span></td>
                    <td class="px-4 py-3 text-right space-x-2">
                        <button onclick="window.loadReportForEdit('${doc.id}')" title="Editar" class="text-blue-600 border border-blue-200 px-2 py-1 rounded hover:bg-blue-50"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="window.deleteReport('${doc.id}', '${doc.reportInfo?.number}', '${doc.student?.name?.replace(/'/g, "\\'")}')" title="Eliminar" class="text-red-600 border border-red-200 px-2 py-1 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        window.loadReportForEdit = function(docId) {
            const report = cachedHistory.find(r => r.id === docId);
            if(report) {
                data = { ...report };
                renderFicha(); renderAnalisis(); renderDecision(); renderTutoria();
                updateUI('name', data.student.name); updateUI('run', data.student.run);
                if(data.reportInfo?.number) document.getElementById('report-number-input').value = data.reportInfo.number;
                if(data.logoUrl) window.applyLogoToAll(data.logoUrl);
                window.switchTab('ficha');
            }
        };

        window.loadLogo = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => { data.logoUrl = e.target.result; window.applyLogoToAll(data.logoUrl); };
                reader.readAsDataURL(file);
            }
        };

        window.applyLogoToAll = function(url) {
            document.getElementById('screen-logo-container').innerHTML = `<img src="${url}" class="w-full h-full object-contain">`;
            document.getElementById('screen-logo-container').classList.replace('bg-blue-800', 'bg-white');
            const repLogo = document.getElementById('print-logo-repitencia');
            repLogo.src = url; repLogo.classList.remove('hidden');
            document.getElementById('placeholder-logo-rep').classList.add('hidden');
            const tutLogo = document.getElementById('print-logo-tutoria');
            if(tutLogo) { tutLogo.src = url; tutLogo.classList.remove('hidden'); document.getElementById('placeholder-logo-tut').classList.add('hidden'); }
        };

        window.printRepitencia = function() { document.body.classList.remove('printing-tutoria'); document.body.classList.add('printing-repitencia'); window.print(); };
        window.printTutoria = function() { document.body.classList.remove('printing-repitencia'); document.body.classList.add('printing-tutoria'); window.print(); };

        window.switchTab = function(tabId) {
            const tabs = ['ficha', 'analisis', 'decision', 'tutoria', 'historial'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`view-${t}`);
                if (t === tabId) { btn.classList.remove('border-transparent', 'text-slate-500'); btn.classList.add('border-blue-600', 'text-blue-600'); view.classList.remove('hidden-tab'); }
                else { btn.classList.add('border-transparent', 'text-slate-500'); btn.classList.remove('border-blue-600', 'text-blue-600'); view.classList.add('hidden-tab'); }
            });
            const header = document.getElementById('print-header-general');
            const btns = document.getElementById('action-buttons');
            if(tabId === 'tutoria') { header.style.display = 'none'; btns.style.display = 'flex'; }
            else if (tabId === 'historial') { header.style.display = 'none'; btns.style.display = 'none'; window.loadHistoryFromDB(); }
            else { header.style.display = 'block'; btns.style.display = 'flex'; }
        };

        window.appendText = function(path, textToAdd) {
            const keys = path.split('.'); let obj = data; for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
            let currentVal = obj[keys[keys.length - 1]] || "";
            window.updateData(path, currentVal ? currentVal + "\n- " + textToAdd : "- " + textToAdd);
            renderAnalisis();
        };

        window.toggleSuggestions = function(id) { document.getElementById(id).classList.toggle('hidden'); };

        function createSectionHTML(title, iconClass, contentHTML, extraClass = "") {
            return `<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6 ${extraClass} view-section"><div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2"><i class="${iconClass} text-blue-600 text-lg"></i><h3 class="text-lg font-semibold text-slate-800">${title}</h3></div>${contentHTML}</div>`;
        }

        function createCriteriaSelector(title, key, path, id) {
            const options = criteriaOptions[key].map(opt => `<button onclick="window.appendText('${path}', '${opt}')" class="suggestion-btn w-full text-left p-2 text-sm text-slate-600 hover:bg-blue-50 border-b border-slate-100 flex gap-2"><i class="fa-solid fa-plus mt-1 text-xs opacity-50"></i> ${opt}</button>`).join('');
            return `<div class="suggestion-btn-container no-print mb-3"><button onclick="window.toggleSuggestions('${id}')" class="text-xs font-bold text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1.5 rounded-full flex items-center gap-1"><i class="fa-solid fa-lightbulb"></i> Sugerencias</button><div id="${id}" class="hidden bg-white border border-slate-200 rounded-lg shadow-lg p-1 mt-1 z-10">${options}</div></div>`;
        }

        // --- ACTUALIZACIÓN: Renderizado con sistema DUAL (Pantalla/Impresión) ---
        function renderFicha() {
            const datos = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div><label class="text-xs font-semibold text-slate-500 uppercase">Nombre</label><input type="text" class="editable font-medium" value="${data.student.name}" oninput="window.updateData('student.name', this.value)"></div><div><label class="text-xs font-semibold text-slate-500 uppercase">RUN</label><input type="text" class="editable font-medium" value="${data.student.run}" oninput="window.updateData('student.run', this.value)"></div><div><label class="text-xs font-semibold text-slate-500 uppercase">Curso</label><input type="text" class="editable font-medium" value="${data.student.course}" oninput="window.updateData('student.course', this.value)"></div><div><label class="text-xs font-semibold text-slate-500 uppercase">Fecha Nac.</label><input type="text" class="editable font-medium" value="${data.student.dob}" placeholder="YYYY-MM-DD" oninput="window.updateData('student.dob', this.value)"></div><div><label class="text-xs font-semibold text-slate-500 uppercase">Apoderado</label><input type="text" class="editable font-medium" value="${data.student.guardian}" oninput="window.updateData('student.guardian', this.value)"></div></div>`;
            const tutor = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-50 p-4 rounded-lg"><label class="text-xs font-semibold text-slate-500 uppercase">Tutor Principal</label><input type="text" class="editable font-medium mb-2" value="${data.student.tutor}" oninput="window.updateData('student.tutor', this.value); window.updateData('tutoria.tutor1', this.value)"><label class="text-xs font-semibold text-slate-500 uppercase">Asignatura</label><input type="text" class="editable text-sm" value="${data.student.tutorSubject}" oninput="window.updateData('student.tutorSubject', this.value)"></div><div class="bg-slate-50 p-4 rounded-lg"><h4 class="font-medium text-slate-700 mb-2">Historial Entrevistas</h4>${window.createEditableBlock('', data.student.interviews, 'student.interviews', 'h-32')}</div></div>`;
            document.getElementById('view-ficha').innerHTML = createSectionHTML("Datos del Estudiante", "fa-solid fa-user", datos) + createSectionHTML("Tutoría y Acompañamiento", "fa-solid fa-users", tutor);
        }

        function renderAnalisis() {
            const tableHTML = `
                <table class="w-full text-sm text-left border-collapse mb-6 vertical-grades-table">
                    <thead class="bg-slate-100 uppercase text-xs">
                        <tr><th class="border border-slate-300 p-2">Indicador</th><th class="border border-slate-300 p-2 text-center">Calificación</th></tr>
                    </thead>
                    <tbody>
                        <tr><td class="border border-slate-300 p-2 font-bold">Promedio 1º Semestre</td><td class="border border-slate-300 p-0"><input id="input-sem1" type="number" step="0.1" class="editable text-center font-bold text-red-600" value="${data.academic.sem1Avg}" oninput="window.updateData('academic.sem1Avg', this.value)"></td></tr>
                        <tr><td class="border border-slate-300 p-2 font-bold">Promedio 2º Semestre</td><td class="border border-slate-300 p-0"><input id="input-sem2" type="number" step="0.1" class="editable text-center font-bold text-amber-600" value="${data.academic.sem2Avg}" oninput="window.updateData('academic.sem2Avg', this.value)"></td></tr>
                        <tr><td class="border border-slate-300 p-2 font-bold bg-blue-50">PROMEDIO FINAL</td><td class="border border-slate-300 p-0 bg-blue-50"><input id="input-final-avg" type="number" step="0.1" class="editable text-center font-bold text-slate-900 auto-calculated" value="${data.academic.finalAvg}" oninput="window.updateData('academic.finalAvg', this.value)"></td></tr>
                        <tr><td class="border border-slate-300 p-2 text-slate-500">Promedio del Curso</td><td class="border border-slate-300 p-0"><input id="input-course" type="number" step="0.1" class="editable text-center text-slate-600" value="${data.academic.courseAvg}" oninput="window.updateData('academic.courseAvg', this.value)"></td></tr>
                    </tbody>
                </table>`;
            
            const asig = `<p class="text-xs text-slate-500 mb-2 no-print">Asignaturas y notas:</p>${window.createEditableBlock('', data.academic.failedSubjectsText, 'academic.failedSubjectsText', 'h-24', 'text-red-800')}`;
            
            const ana = `<div class="space-y-4">
                <div class="relative pl-4 border-l-4 border-blue-500">
                    ${createCriteriaSelector('Sugerencias', 'progress', 'decree67Analysis.progress', 'sugg-progress')}
                    ${window.createEditableBlock('Criterio A: Progreso', data.decree67Analysis.progress, 'decree67Analysis.progress')}
                </div>
                <div class="relative pl-4 border-l-4 border-blue-500">
                    ${createCriteriaSelector('Sugerencias', 'gap', 'decree67Analysis.gap', 'sugg-gap')}
                    <div class="bg-slate-50 p-2 rounded mt-2 mb-2" id="chart-container"></div>
                    ${window.createEditableBlock('Criterio B: Brecha', data.decree67Analysis.gap, 'decree67Analysis.gap')}
                </div>
                <div class="relative pl-4 border-l-4 border-purple-500">
                    ${createCriteriaSelector('Sugerencias', 'socioemotional', 'decree67Analysis.socioemotional', 'sugg-socio')}
                    ${window.createEditableBlock('Criterio C: Socioemocional', data.decree67Analysis.socioemotional, 'decree67Analysis.socioemotional')}
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200">
                    ${window.createEditableBlock('Evidencias Adicionales', data.decree67Analysis.additionalEvidence, 'decree67Analysis.additionalEvidence', 'h-24')}
                </div>
            </div>`;
            document.getElementById('view-analisis').innerHTML = tableHTML + createSectionHTML("Asignaturas con Riesgo", "fa-solid fa-arrow-trend-down", asig) + createSectionHTML("Análisis Integral Art. 11", "fa-solid fa-chart-bar", ana);
            renderChartBars();
        }

        function renderChartBars() {
            const container = document.getElementById('chart-container'); if(!container) return;
            const wEst = Math.min((data.academic.finalAvg/7)*100, 100), wCur = Math.min((data.academic.courseAvg/7)*100, 100);
            container.innerHTML = `<div class="flex items-center gap-4 mb-2"><span class="w-20 text-xs font-bold">Estudiante</span><div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-red-500 transition-all duration-300" style="width: ${wEst}%"></div></div><span class="text-xs font-bold">${data.academic.finalAvg}</span></div><div class="flex items-center gap-4"><span class="w-20 text-xs font-bold">Curso</span><div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-blue-500 transition-all duration-300" style="width: ${wCur}%"></div></div><span class="text-xs font-bold">${data.academic.courseAvg}</span></div>`;
        }

        function renderDecision() {
            const isRep = data.decision.status === 'Repitencia';
            const html = `<div class="p-4 rounded-lg border-l-4 shadow-sm mb-4 ${isRep?'bg-red-50 border-red-500':'bg-green-50 border-green-500'}">
                <div class="flex items-center gap-3 mb-2"><h2 class="text-2xl font-bold">Decisión:</h2><select class="editable text-xl font-bold uppercase w-auto bg-white border-slate-300 rounded" onchange="window.updateData('decision.status', this.value); renderDecision()"><option value="Repitencia" ${isRep?'selected':''}>Repitencia</option><option value="Aprobación" ${!isRep?'selected':''}>Aprobación</option></select></div>
                ${window.createEditableBlock('Fundamentación:', data.decision.justification, 'decision.justification', 'h-24 italic')}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-bold text-blue-800 mb-2">Compromisos Establecimiento</h4>
                    ${window.createEditableBlock('', data.plan2025.schoolCommitments, 'plan2025.schoolCommitments', 'h-48')}
                </div>
                <div>
                    <h4 class="font-bold text-purple-800 mb-2">Compromisos Familia</h4>
                    ${window.createEditableBlock('', data.plan2025.familyCommitments, 'plan2025.familyCommitments', 'h-48')}
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-slate-300 grid grid-cols-2 gap-12 text-center"><div><div class="h-10 border-b border-slate-400 mb-1"></div><p class="font-bold">Profesor Jefe</p></div><div><div class="h-10 border-b border-slate-400 mb-1"></div><p class="font-bold">Alejandra Morales G.</p><p class="text-sm">Unidad Técnico Pedagógica</p></div></div>`;
            document.getElementById('view-decision').innerHTML = createSectionHTML("Plan de Acompañamiento", "fa-solid fa-file-contract", html);
        }

        function renderTutoria() {
            const controls = `
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100 no-print flex flex-col md:flex-row gap-4 justify-between">
                    <div class="flex gap-4">
                        <label class="flex gap-2 text-sm cursor-pointer"><input type="checkbox" ${data.tutoria.showSem1?'checked':''} onchange="window.updateData('tutoria.showSem1', this.checked)"> Incluir 1º Semestre</label>
                        <label class="flex gap-2 text-sm cursor-pointer"><input type="checkbox" ${data.tutoria.showSem2?'checked':''} onchange="window.updateData('tutoria.showSem2', this.checked)"> Incluir 2º Semestre</label>
                    </div>
                    <div class="template-buttons flex gap-2">
                        <span class="text-xs font-bold text-blue-800 self-center">Plantillas Rápidas:</span>
                        <button onclick="window.fillTutoriaTemplate('success')" class="text-xs bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded border border-green-300" title="Superó dificultades"><i class="fa-solid fa-check"></i> Logrado</button>
                        <button onclick="window.fillTutoriaTemplate('process')" class="text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded border border-yellow-300" title="Avance parcial"><i class="fa-solid fa-hourglass-half"></i> En Proceso</button>
                        <button onclick="window.fillTutoriaTemplate('fail')" class="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded border border-red-300" title="No logro objetivos"><i class="fa-solid fa-xmark"></i> No Logrado</button>
                    </div>
                </div>`;
            const header = `<div class="print-header-flex border-b-2 border-slate-800 pb-4 mb-4"><div class="flex-shrink-0 w-24 h-24 flex items-center justify-center"><img id="print-logo-tutoria" src="${data.logoUrl||''}" class="print-logo w-full h-full object-contain ${data.logoUrl?'':'hidden'}"><div id="placeholder-logo-tut" class="text-xs text-slate-400 border-2 border-dashed p-1 rounded no-print ${data.logoUrl?'hidden':''}">Logo</div></div><div class="text-center flex-1"><h1 class="text-3xl font-bold">INFORME TUTORÍA</h1><p class="text-sm font-bold text-slate-500 mt-2">INFORMACIÓN PERSONAL</p></div><div class="text-right text-sm"><div class="flex justify-end items-center gap-2"><span class="font-bold">Nº:</span><input type="text" class="font-bold text-red-600 text-right transparent-input w-24" value="${data.tutoria.reportNumber}" oninput="window.updateData('tutoria.reportNumber', this.value)"></div></div></div>`;
            const info = `<div class="grid grid-cols-[150px_1fr] gap-y-2 mb-8 text-sm border-b border-slate-200 pb-6 avoid-break">
                <div class="font-bold">Tutor 1:</div><input type="text" class="editable border-b border-dotted p-0" value="${data.tutoria.tutor1}" oninput="window.updateData('tutoria.tutor1', this.value)">
                <div class="font-bold">Tutor 2:</div><input type="text" class="editable border-b border-dotted p-0" value="${data.tutoria.tutor2}" oninput="window.updateData('tutoria.tutor2', this.value)">
                <div class="font-bold mt-1">Estudiante:</div><input id="input-tut-name" type="text" class="editable border-b border-dotted p-0 font-medium" value="${data.student.name}" oninput="window.updateData('student.name', this.value)">
                <div class="font-bold">RUN:</div><input id="input-tut-run" type="text" class="editable border-b border-dotted p-0 font-medium" value="${data.student.run}" oninput="window.updateData('student.run', this.value)">
                <div class="font-bold">Curso:</div><input id="input-tut-course" type="text" class="editable border-b border-dotted p-0 font-medium" value="${data.student.course}" oninput="window.updateData('student.course', this.value)">
                <div class="font-bold">Fecha:</div><input type="date" class="editable border-b border-dotted p-0" value="${data.tutoria.reportDate}" oninput="window.updateData('tutoria.reportDate', this.value)">
            </div>`;
            const createSem = (n, d, p) => `
                <div class="mb-8 print-spacer avoid-break">
                    <h3 class="font-bold border-b-2 border-slate-800 mb-4 pb-1 uppercase text-lg bg-slate-100 px-2">Tutoría Semestre Nº ${n}</h3>
                    <div class="grid grid-cols-2 gap-8 mb-6 bg-slate-50 p-3 rounded border border-slate-200 avoid-break">
                        <div class="flex flex-col"><label class="font-bold text-xs uppercase text-slate-500">Mes Inicio</label><input class="editable font-medium" value="${d.startMonth}" oninput="window.updateData('${p}.startMonth', this.value)"></div>
                        <div class="flex flex-col"><label class="font-bold text-xs uppercase text-slate-500">Mes Término</label><input class="editable font-medium" value="${d.endMonth}" oninput="window.updateData('${p}.endMonth', this.value)"></div>
                    </div>
                    <div class="space-y-6">
                        ${window.createEditableBlock('Diagnóstico / Situación', d.situation, `${p}.situation`)}
                        ${window.createEditableBlock('Acuerdos Tomados', d.agreements, `${p}.agreements`)}
                        ${window.createEditableBlock('Compromisos (Estudiante/Familia)', d.commitments, `${p}.commitments`)}
                        ${window.createEditableBlock('Observaciones Finales', d.observations, `${p}.observations`)}
                    </div>
                </div>`;
            const sem1 = data.tutoria.showSem1 ? createSem(1, data.tutoria.sem1, 'tutoria.sem1') : '';
            const sem2 = data.tutoria.showSem2 ? createSem(2, data.tutoria.sem2, 'tutoria.sem2') : '';
            const signs = `<div class="mt-12 pt-8 border-t border-slate-300 grid grid-cols-2 gap-12 text-center avoid-break"><div class="mt-8"><div class="h-px bg-slate-400 mb-2 w-3/4 mx-auto"></div><p class="font-bold text-sm">Firma Profesor Tutor</p></div><div class="mt-8"><div class="h-px bg-slate-400 mb-2 w-3/4 mx-auto"></div><p class="font-bold text-sm">Alejandra Morales G.</p><p class="text-xs text-slate-500">Unidad Técnico Pedagógica</p></div></div>`;
            document.getElementById('view-tutoria').innerHTML = controls + `<div class="bg-white p-10 rounded-lg shadow-sm border border-slate-200 print:border-none print:shadow-none print:p-0 max-w-[21cm] mx-auto">${header}${info}${sem1}${sem2}${signs}</div>`;
            setTimeout(() => { document.querySelectorAll('#view-tutoria textarea.auto-grow').forEach(el => window.autoResize(el)); }, 50);
        }

        renderFicha(); renderAnalisis(); renderDecision(); renderTutoria();
        window.switchTab('ficha');
    </script>
</body>
</html>